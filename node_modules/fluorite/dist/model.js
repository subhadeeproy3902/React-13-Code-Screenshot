'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _defineProperty2 = require('babel-runtime/helpers/defineProperty');

var _defineProperty3 = _interopRequireDefault(_defineProperty2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _lodash = require('lodash');

var _query = require('./query');

var _errors = require('./errors');

var _errors2 = _interopRequireDefault(_errors);

var _relations = require('./relations');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright (c) 2017 Roman Lakhtadyr
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

exports.default = function (fluorite) {
  var _class, _temp;

  return _temp = _class = function () {
    (0, _createClass3.default)(Model, null, [{
      key: 'create',
      value: function create(attrs) {
        return new this(attrs);
      }
    }, {
      key: 'objects',
      value: function objects() {
        return new _query.MultipleRowsQuery(this);
      }
    }, {
      key: 'find',
      value: function find(id) {
        return this.objects().first((0, _defineProperty3.default)({}, this.idAttribute, id));
      }
    }, {
      key: 'fluorite',
      get: function get() {
        return fluorite;
      }
    }, {
      key: 'knex',
      get: function get() {
        return this.fluorite.knex;
      }
    }]);

    function Model(attributes) {
      var previousAttributes = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
      (0, _classCallCheck3.default)(this, Model);

      this.attributes = attributes;
      this.previousAttributes = previousAttributes;
      this.relatedModels = {};
    }

    (0, _createClass3.default)(Model, [{
      key: 'createKnexQuery',
      value: function createKnexQuery() {
        var knex = this.constructor.knex;
        var transaction = this.constructor.fluorite.transaction;

        if (transaction.isTransacting()) {
          return knex.transacting(transaction.currentTransaction()).from(this.constructor.table);
        }

        return this.constructor.knex.from(this.constructor.table);
      }
    }, {
      key: 'get',
      value: function get(name) {
        return this.attributes[name];
      }
    }, {
      key: 'related',
      value: function related(name) {
        return this.relatedModels[name];
      }
    }, {
      key: 'set',
      value: function set(name, value) {
        if (name instanceof Object) {
          this.attributes = (0, _extends3.default)({}, this.attributes, name);
          return;
        }
        this.attributes[name] = value;
      }
    }, {
      key: 'hasMany',
      value: function hasMany(relatedClass) {
        var foreignKey = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.constructor.name.toLowerCase() + '_id';
        var foreignKeyTarget = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.constructor.idAttribute;

        return new _relations.HasMany(this, relatedClass, foreignKey, foreignKeyTarget);
      }
    }, {
      key: 'belongsTo',
      value: function belongsTo(relatedClass) {
        var foreignKey = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : relatedClass.name.toLowerCase() + '_id';
        var foreignKeyTarget = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : relatedClass.idAttribute;

        return new _relations.BelongsTo(this, relatedClass, foreignKey, foreignKeyTarget);
      }
    }, {
      key: 'belongsToMany',
      value: function belongsToMany(relatedClass) {
        var pivotTableName = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : (0, _lodash.sortBy)([this.constructor.table, relatedClass.table]).join('_');
        var thisForeignKey = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.constructor.name.toLowerCase() + '_id';
        var thatForeignKey = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : relatedClass.name.toLowerCase() + '_id';
        var thisForeignKeyTarget = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : this.constructor.idAttribute;
        var thatForeignKeyTarget = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : relatedClass.idAttribute;

        return new _relations.BelongsToMany(this, relatedClass, pivotTableName, thisForeignKey, thatForeignKey, thisForeignKeyTarget, thatForeignKeyTarget);
      }
    }, {
      key: 'toJSON',
      value: function toJSON() {
        return (0, _extends3.default)({}, (0, _lodash.pickBy)(this.attributes, function (val, key) {
          return !(0, _lodash.startsWith)(key, '__');
        }), (0, _lodash.mapValues)(this.relatedModels, function (modelOrModels) {
          return Array.isArray(modelOrModels) ? modelOrModels.map(function (m) {
            return m.toJSON();
          }) : modelOrModels.toJSON();
        }));
      }
    }, {
      key: 'setRelatedData',
      value: function setRelatedData(name, data) {
        this.relatedModels[name] = data;
      }

      /*
       * Methods that executes SQL statements
       */

    }, {
      key: 'save',
      value: function () {
        var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(name, value) {
          return _regenerator2.default.wrap(function _callee$(_context) {
            while (1) {
              switch (_context.prev = _context.next) {
                case 0:
                  if ((0, _lodash.isEmpty)(name)) {
                    _context.next = 3;
                    break;
                  }

                  this.set(name, value);
                  return _context.abrupt('return', this.update());

                case 3:
                  if (!this.isNew) {
                    _context.next = 5;
                    break;
                  }

                  return _context.abrupt('return', this.insert());

                case 5:
                  return _context.abrupt('return', this.update());

                case 6:
                case 'end':
                  return _context.stop();
              }
            }
          }, _callee, this);
        }));

        function save(_x11, _x12) {
          return _ref.apply(this, arguments);
        }

        return save;
      }()
    }, {
      key: 'refresh',
      value: function () {
        var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2() {
          var attributes;
          return _regenerator2.default.wrap(function _callee2$(_context2) {
            while (1) {
              switch (_context2.prev = _context2.next) {
                case 0:
                  _context2.next = 2;
                  return this.createKnexQuery().from(this.constructor.table).where(this.constructor.idAttribute, this.id).first();

                case 2:
                  attributes = _context2.sent;


                  this.attributes = attributes;
                  this.previousAttributes = (0, _assign2.default)({}, attributes);

                case 5:
                case 'end':
                  return _context2.stop();
              }
            }
          }, _callee2, this);
        }));

        function refresh() {
          return _ref2.apply(this, arguments);
        }

        return refresh;
      }()
    }, {
      key: 'remove',
      value: function () {
        var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3() {
          return _regenerator2.default.wrap(function _callee3$(_context3) {
            while (1) {
              switch (_context3.prev = _context3.next) {
                case 0:
                  if (!this.isNew) {
                    _context3.next = 2;
                    break;
                  }

                  throw new this.constructor.NotFoundError('Can\'t remove new entity');

                case 2:
                  _context3.next = 4;
                  return this.createKnexQuery().where(this.constructor.idAttribute, this.id).delete();

                case 4:
                case 'end':
                  return _context3.stop();
              }
            }
          }, _callee3, this);
        }));

        function remove() {
          return _ref3.apply(this, arguments);
        }

        return remove;
      }()
    }, {
      key: 'insert',
      value: function () {
        var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4() {
          var ids, lastId;
          return _regenerator2.default.wrap(function _callee4$(_context4) {
            while (1) {
              switch (_context4.prev = _context4.next) {
                case 0:
                  _context4.next = 2;
                  return this.createKnexQuery().insert(this.attributesWithoutId, this.constructor.idAttribute);

                case 2:
                  ids = _context4.sent;
                  lastId = (0, _lodash.last)(ids);

                  this.attributes[this.constructor.idAttribute] = lastId;
                  this.previousAttributes = this.attributes;
                  return _context4.abrupt('return', lastId);

                case 7:
                case 'end':
                  return _context4.stop();
              }
            }
          }, _callee4, this);
        }));

        function insert() {
          return _ref4.apply(this, arguments);
        }

        return insert;
      }()
    }, {
      key: 'update',
      value: function () {
        var _ref5 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5() {
          var updatedAttributes;
          return _regenerator2.default.wrap(function _callee5$(_context5) {
            while (1) {
              switch (_context5.prev = _context5.next) {
                case 0:
                  updatedAttributes = this.updatedAttributes;

                  if (!(0, _lodash.isEmpty)(updatedAttributes)) {
                    _context5.next = 3;
                    break;
                  }

                  return _context5.abrupt('return');

                case 3:
                  _context5.next = 5;
                  return this.createKnexQuery().update(updatedAttributes).where((0, _defineProperty3.default)({}, this.constructor.idAttribute, this.id));

                case 5:
                  this.previousAttributes = this.attributes;

                case 6:
                case 'end':
                  return _context5.stop();
              }
            }
          }, _callee5, this);
        }));

        function update() {
          return _ref5.apply(this, arguments);
        }

        return update;
      }()
    }, {
      key: 'load',
      value: function () {
        var _ref6 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6(relation) {
          var data;
          return _regenerator2.default.wrap(function _callee6$(_context6) {
            while (1) {
              switch (_context6.prev = _context6.next) {
                case 0:
                  _context6.next = 2;
                  return this[relation]();

                case 2:
                  data = _context6.sent;

                  this.setRelatedData(relation, data);

                case 4:
                case 'end':
                  return _context6.stop();
              }
            }
          }, _callee6, this);
        }));

        function load(_x13) {
          return _ref6.apply(this, arguments);
        }

        return load;
      }()
    }, {
      key: 'id',
      get: function get() {
        return this.attributes[this.constructor.idAttribute];
      }
    }, {
      key: 'attributesWithoutId',
      get: function get() {
        var _this = this;

        return (0, _lodash.pickBy)(this.attributes, function (value, key) {
          return key !== _this.constructor.idAttribute;
        });
      }
    }, {
      key: 'updatedAttributes',
      get: function get() {
        var _this2 = this;

        return (0, _lodash.pickBy)(this.attributesWithoutId, function (value, key) {
          return value !== _this2.previousAttributes[key];
        });
      }
    }, {
      key: 'isNew',
      get: function get() {
        return (0, _lodash.isNil)(this.id);
      }
    }]);
    return Model;
  }(), _class.NotFoundError = function (_errors$NotFoundError) {
    (0, _inherits3.default)(NotFoundError, _errors$NotFoundError);

    function NotFoundError() {
      (0, _classCallCheck3.default)(this, NotFoundError);
      return (0, _possibleConstructorReturn3.default)(this, (NotFoundError.__proto__ || (0, _getPrototypeOf2.default)(NotFoundError)).apply(this, arguments));
    }

    return NotFoundError;
  }(_errors2.default.NotFoundError), _class.IntegrityError = function (_errors$IntegrityErro) {
    (0, _inherits3.default)(IntegrityError, _errors$IntegrityErro);

    function IntegrityError() {
      (0, _classCallCheck3.default)(this, IntegrityError);
      return (0, _possibleConstructorReturn3.default)(this, (IntegrityError.__proto__ || (0, _getPrototypeOf2.default)(IntegrityError)).apply(this, arguments));
    }

    return IntegrityError;
  }(_errors2.default.IntegrityError), _class.table = null, _class.idAttribute = 'id', _class.scopes = {}, _temp;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC5qcyJdLCJuYW1lcyI6WyJhdHRycyIsImlkIiwib2JqZWN0cyIsImZpcnN0IiwiaWRBdHRyaWJ1dGUiLCJmbHVvcml0ZSIsImtuZXgiLCJhdHRyaWJ1dGVzIiwicHJldmlvdXNBdHRyaWJ1dGVzIiwicmVsYXRlZE1vZGVscyIsImNvbnN0cnVjdG9yIiwidHJhbnNhY3Rpb24iLCJpc1RyYW5zYWN0aW5nIiwidHJhbnNhY3RpbmciLCJjdXJyZW50VHJhbnNhY3Rpb24iLCJmcm9tIiwidGFibGUiLCJuYW1lIiwidmFsdWUiLCJPYmplY3QiLCJyZWxhdGVkQ2xhc3MiLCJmb3JlaWduS2V5IiwidG9Mb3dlckNhc2UiLCJmb3JlaWduS2V5VGFyZ2V0IiwicGl2b3RUYWJsZU5hbWUiLCJqb2luIiwidGhpc0ZvcmVpZ25LZXkiLCJ0aGF0Rm9yZWlnbktleSIsInRoaXNGb3JlaWduS2V5VGFyZ2V0IiwidGhhdEZvcmVpZ25LZXlUYXJnZXQiLCJ2YWwiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJtb2RlbE9yTW9kZWxzIiwibWFwIiwibSIsInRvSlNPTiIsImRhdGEiLCJzZXQiLCJ1cGRhdGUiLCJpc05ldyIsImluc2VydCIsImNyZWF0ZUtuZXhRdWVyeSIsIndoZXJlIiwiTm90Rm91bmRFcnJvciIsImRlbGV0ZSIsImF0dHJpYnV0ZXNXaXRob3V0SWQiLCJpZHMiLCJsYXN0SWQiLCJ1cGRhdGVkQXR0cmlidXRlcyIsInJlbGF0aW9uIiwic2V0UmVsYXRlZERhdGEiLCJJbnRlZ3JpdHlFcnJvciIsInNjb3BlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXNCQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBekJBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2tCQTJCZTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBLDZCQWdCQ0EsS0FoQkQsRUFnQlE7QUFDbkIsZUFBTyxJQUFJLElB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TCxDQUFnQixLQUFLRyxXQUFMLENBQWlCTixXQUFqQyxDQUFQO0FBQ0Q7QUFwQ1k7QUFBQTtBQUFBLDBCQXNDYTtBQUFBOztBQUN4QixlQUFPLG9CQUFPLEtBQUtHLFVBQVosRUFBd0IsVUFBQ1csS0FBRCxFQUFRYSxHQUFSO0FBQUEsaUJBQzdCQSxRQUFRLE1BQUtyQixXQUFMLENBQWlCTixXQURJO0FBQUEsU0FBeEIsQ0FBUDtBQUdEO0FBMUNZO0FBQUE7QUFBQSwwQkE0Q1c7QUFBQTs7QUFDdEIsZUFBTyxvQkFBTyxLQUFLMkMsbUJBQVosRUFBaUMsVUFBQzdCLEtBQUQsRUFBUWEsR0FBUjtBQUFBLGlCQUN0Q2IsVUFBVSxPQUFLVixrQkFBTCxDQUF3QnVCLEdBQXhCLENBRDRCO0FBQUEsU0FBakMsQ0FBUDtBQUdEO0FBaERZO0FBQUE7QUFBQSwwQkFrREQ7QUFDVixlQUFPLG1CQUFNLEtBQUs5QixFQUFYLENBQVA7QUFDRDtBQXBEWTtBQUFBO0FBQUEsY0FDTjRDLGFBRE07QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFBQTtBQUFBLElBQ3NDLGlCQUFPQSxhQUQ3QyxVQUVOUSxjQUZNO0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFBQSxJQUV3QyxpQkFBT0EsY0FGL0MsVUFJTnJDLEtBSk0sR0FJRSxJQUpGLFNBS05aLFdBTE0sR0FLUSxJQUxSLFNBTU5rRCxNQU5NLEdBTUcsRUFOSDtBQUFBLEMiLCJmaWxlIjoibW9kZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDE3IFJvbWFuIExha2h0YWR5clxuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKi9cblxuaW1wb3J0IHsgcGlja0J5LCBpc05pbCwgbGFzdCwgaXNFbXB0eSwgc29ydEJ5LCBtYXBWYWx1ZXMsIHN0YXJ0c1dpdGggfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgTXVsdGlwbGVSb3dzUXVlcnkgfSBmcm9tICcuL3F1ZXJ5JztcbmltcG9ydCBlcnJvcnMgZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0IHsgQmVsb25nc1RvLCBCZWxvbmdzVG9NYW55LCBIYXNNYW55IH0gZnJvbSAnLi9yZWxhdGlvbnMnO1xuXG5leHBvcnQgZGVmYXVsdCBmbHVvcml0ZSA9PiBjbGFzcyBNb2RlbCB7XG4gIHN0YXRpYyBOb3RGb3VuZEVycm9yID0gY2xhc3MgTm90Rm91bmRFcnJvciBleHRlbmRzIGVycm9ycy5Ob3RGb3VuZEVycm9yIHsgfTtcbiAgc3RhdGljIEludGVncml0eUVycm9yID0gY2xhc3MgSW50ZWdyaXR5RXJyb3IgZXh0ZW5kcyBlcnJvcnMuSW50ZWdyaXR5RXJyb3IgeyB9O1xuXG4gIHN0YXRpYyB0YWJsZSA9IG51bGw7XG4gIHN0YXRpYyBpZEF0dHJpYnV0ZSA9ICdpZCc7XG4gIHN0YXRpYyBzY29wZXMgPSB7fTtcblxuICBzdGF0aWMgZ2V0IGZsdW9yaXRlKCkge1xuICAgIHJldHVybiBmbHVvcml0ZTtcbiAgfVxuXG4gIHN0YXRpYyBnZXQga25leCgpIHtcbiAgICByZXR1cm4gdGhpcy5mbHVvcml0ZS5rbmV4O1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZShhdHRycykge1xuICAgIHJldHVybiBuZXcgdGhpcyhhdHRycyk7XG4gIH1cblxuICBzdGF0aWMgb2JqZWN0cygpIHtcbiAgICByZXR1cm4gbmV3IE11bHRpcGxlUm93c1F1ZXJ5KHRoaXMpO1xuICB9XG5cbiAgc3RhdGljIGZpbmQoaWQpIHtcbiAgICByZXR1cm4gdGhpcy5vYmplY3RzKCkuZmlyc3QoeyBbdGhpcy5pZEF0dHJpYnV0ZV06IGlkIH0pO1xuICB9XG5cbiAgY29uc3RydWN0b3IoYXR0cmlidXRlcywgcHJldmlvdXNBdHRyaWJ1dGVzID0ge30pIHtcbiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzO1xuICAgIHRoaXMucHJldmlvdXNBdHRyaWJ1dGVzID0gcHJldmlvdXNBdHRyaWJ1dGVzO1xuICAgIHRoaXMucmVsYXRlZE1vZGVscyA9IHt9O1xuICB9XG5cbiAgZ2V0IGlkKCkge1xuICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbdGhpcy5jb25zdHJ1Y3Rvci5pZEF0dHJpYnV0ZV07XG4gIH1cblxuICBnZXQgYXR0cmlidXRlc1dpdGhvdXRJZCgpIHtcbiAgICByZXR1cm4gcGlja0J5KHRoaXMuYXR0cmlidXRlcywgKHZhbHVlLCBrZXkpID0+IChcbiAgICAgIGtleSAhPT0gdGhpcy5jb25zdHJ1Y3Rvci5pZEF0dHJpYnV0ZVxuICAgICkpO1xuICB9XG5cbiAgZ2V0IHVwZGF0ZWRBdHRyaWJ1dGVzKCkge1xuICAgIHJldHVybiBwaWNrQnkodGhpcy5hdHRyaWJ1dGVzV2l0aG91dElkLCAodmFsdWUsIGtleSkgPT4gKFxuICAgICAgdmFsdWUgIT09IHRoaXMucHJldmlvdXNBdHRyaWJ1dGVzW2tleV1cbiAgICApKTtcbiAgfVxuXG4gIGdldCBpc05ldygpIHtcbiAgICByZXR1cm4gaXNOaWwodGhpcy5pZCk7XG4gIH1cblxuICBjcmVhdGVLbmV4UXVlcnkoKSB7XG4gICAgY29uc3Qga25leCA9IHRoaXMuY29uc3RydWN0b3Iua25leDtcbiAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRoaXMuY29uc3RydWN0b3IuZmx1b3JpdGUudHJhbnNhY3Rpb247XG5cbiAgICBpZiAodHJhbnNhY3Rpb24uaXNUcmFuc2FjdGluZygpKSB7XG4gICAgICByZXR1cm4ga25leC50cmFuc2FjdGluZyh0cmFuc2FjdGlvbi5jdXJyZW50VHJhbnNhY3Rpb24oKSlcbiAgICAgICAgLmZyb20odGhpcy5jb25zdHJ1Y3Rvci50YWJsZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iua25leC5mcm9tKHRoaXMuY29uc3RydWN0b3IudGFibGUpO1xuICB9XG5cbiAgZ2V0KG5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW25hbWVdO1xuICB9XG5cbiAgcmVsYXRlZChuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMucmVsYXRlZE1vZGVsc1tuYW1lXTtcbiAgfVxuXG4gIHNldChuYW1lLCB2YWx1ZSkge1xuICAgIGlmIChuYW1lIGluc3RhbmNlb2YgT2JqZWN0KSB7XG4gICAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7IC4uLnRoaXMuYXR0cmlidXRlcywgLi4ubmFtZSB9O1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmF0dHJpYnV0ZXNbbmFtZV0gPSB2YWx1ZTtcbiAgfVxuXG4gIGhhc01hbnkoXG4gICAgcmVsYXRlZENsYXNzLFxuICAgIGZvcmVpZ25LZXkgPSBgJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWUudG9Mb3dlckNhc2UoKX1faWRgLFxuICAgIGZvcmVpZ25LZXlUYXJnZXQgPSB0aGlzLmNvbnN0cnVjdG9yLmlkQXR0cmlidXRlLFxuICApIHtcbiAgICByZXR1cm4gbmV3IEhhc01hbnkodGhpcywgcmVsYXRlZENsYXNzLCBmb3JlaWduS2V5LCBmb3JlaWduS2V5VGFyZ2V0KTtcbiAgfVxuXG4gIGJlbG9uZ3NUbyhcbiAgICByZWxhdGVkQ2xhc3MsXG4gICAgZm9yZWlnbktleSA9IGAke3JlbGF0ZWRDbGFzcy5uYW1lLnRvTG93ZXJDYXNlKCl9X2lkYCxcbiAgICBmb3JlaWduS2V5VGFyZ2V0ID0gcmVsYXRlZENsYXNzLmlkQXR0cmlidXRlLFxuICApIHtcbiAgICByZXR1cm4gbmV3IEJlbG9uZ3NUbyh0aGlzLCByZWxhdGVkQ2xhc3MsIGZvcmVpZ25LZXksIGZvcmVpZ25LZXlUYXJnZXQpO1xuICB9XG5cbiAgYmVsb25nc1RvTWFueShcbiAgICByZWxhdGVkQ2xhc3MsXG4gICAgcGl2b3RUYWJsZU5hbWUgPSBzb3J0QnkoW3RoaXMuY29uc3RydWN0b3IudGFibGUsIHJlbGF0ZWRDbGFzcy50YWJsZV0pLmpvaW4oJ18nKSxcbiAgICB0aGlzRm9yZWlnbktleSA9IGAke3RoaXMuY29uc3RydWN0b3IubmFtZS50b0xvd2VyQ2FzZSgpfV9pZGAsXG4gICAgdGhhdEZvcmVpZ25LZXkgPSBgJHtyZWxhdGVkQ2xhc3MubmFtZS50b0xvd2VyQ2FzZSgpfV9pZGAsXG4gICAgdGhpc0ZvcmVpZ25LZXlUYXJnZXQgPSB0aGlzLmNvbnN0cnVjdG9yLmlkQXR0cmlidXRlLFxuICAgIHRoYXRGb3JlaWduS2V5VGFyZ2V0ID0gcmVsYXRlZENsYXNzLmlkQXR0cmlidXRlLFxuICApIHtcbiAgICByZXR1cm4gbmV3IEJlbG9uZ3NUb01hbnkoXG4gICAgICB0aGlzLFxuICAgICAgcmVsYXRlZENsYXNzLFxuICAgICAgcGl2b3RUYWJsZU5hbWUsXG4gICAgICB0aGlzRm9yZWlnbktleSxcbiAgICAgIHRoYXRGb3JlaWduS2V5LFxuICAgICAgdGhpc0ZvcmVpZ25LZXlUYXJnZXQsXG4gICAgICB0aGF0Rm9yZWlnbktleVRhcmdldCxcbiAgICApO1xuICB9XG5cbiAgdG9KU09OKCkge1xuICAgIHJldHVybiB7XG4gICAgICAuLi5waWNrQnkoXG4gICAgICAgIHRoaXMuYXR0cmlidXRlcyxcbiAgICAgICAgKHZhbCwga2V5KSA9PiAhc3RhcnRzV2l0aChrZXksICdfXycpLFxuICAgICAgKSxcbiAgICAgIC4uLm1hcFZhbHVlcyhcbiAgICAgICAgdGhpcy5yZWxhdGVkTW9kZWxzLFxuICAgICAgICBtb2RlbE9yTW9kZWxzID0+IChcbiAgICAgICAgICBBcnJheS5pc0FycmF5KG1vZGVsT3JNb2RlbHMpXG4gICAgICAgICAgICA/IG1vZGVsT3JNb2RlbHMubWFwKG0gPT4gbS50b0pTT04oKSlcbiAgICAgICAgICAgIDogbW9kZWxPck1vZGVscy50b0pTT04oKVxuICAgICAgICApLFxuICAgICAgKSxcbiAgICB9O1xuICB9XG5cbiAgc2V0UmVsYXRlZERhdGEobmFtZSwgZGF0YSkge1xuICAgIHRoaXMucmVsYXRlZE1vZGVsc1tuYW1lXSA9IGRhdGE7XG4gIH1cblxuICAvKlxuICAgKiBNZXRob2RzIHRoYXQgZXhlY3V0ZXMgU1FMIHN0YXRlbWVudHNcbiAgICovXG5cbiAgYXN5bmMgc2F2ZShuYW1lLCB2YWx1ZSkge1xuICAgIGlmICghaXNFbXB0eShuYW1lKSkge1xuICAgICAgdGhpcy5zZXQobmFtZSwgdmFsdWUpO1xuICAgICAgcmV0dXJuIHRoaXMudXBkYXRlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNOZXcpIHtcbiAgICAgIHJldHVybiB0aGlzLmluc2VydCgpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAgYXN5bmMgcmVmcmVzaCgpIHtcbiAgICBjb25zdCBhdHRyaWJ1dGVzID0gYXdhaXQgdGhpcy5jcmVhdGVLbmV4UXVlcnkoKVxuICAgICAgLmZyb20odGhpcy5jb25zdHJ1Y3Rvci50YWJsZSlcbiAgICAgIC53aGVyZSh0aGlzLmNvbnN0cnVjdG9yLmlkQXR0cmlidXRlLCB0aGlzLmlkKVxuICAgICAgLmZpcnN0KCk7XG5cbiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzO1xuICAgIHRoaXMucHJldmlvdXNBdHRyaWJ1dGVzID0gT2JqZWN0LmFzc2lnbih7fSwgYXR0cmlidXRlcyk7XG4gIH1cblxuICBhc3luYyByZW1vdmUoKSB7XG4gICAgaWYgKHRoaXMuaXNOZXcpIHtcbiAgICAgIHRocm93IG5ldyB0aGlzLmNvbnN0cnVjdG9yLk5vdEZvdW5kRXJyb3IoJ0NhblxcJ3QgcmVtb3ZlIG5ldyBlbnRpdHknKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUtuZXhRdWVyeSgpXG4gICAgICAud2hlcmUodGhpcy5jb25zdHJ1Y3Rvci5pZEF0dHJpYnV0ZSwgdGhpcy5pZClcbiAgICAgIC5kZWxldGUoKTtcbiAgfVxuXG4gIGFzeW5jIGluc2VydCgpIHtcbiAgICBjb25zdCBpZHMgPSBhd2FpdCB0aGlzLmNyZWF0ZUtuZXhRdWVyeSgpLmluc2VydChcbiAgICAgIHRoaXMuYXR0cmlidXRlc1dpdGhvdXRJZCxcbiAgICAgIHRoaXMuY29uc3RydWN0b3IuaWRBdHRyaWJ1dGUsXG4gICAgKTtcbiAgICBjb25zdCBsYXN0SWQgPSBsYXN0KGlkcyk7XG4gICAgdGhpcy5hdHRyaWJ1dGVzW3RoaXMuY29uc3RydWN0b3IuaWRBdHRyaWJ1dGVdID0gbGFzdElkO1xuICAgIHRoaXMucHJldmlvdXNBdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzO1xuICAgIHJldHVybiBsYXN0SWQ7XG4gIH1cblxuICBhc3luYyB1cGRhdGUoKSB7XG4gICAgY29uc3QgdXBkYXRlZEF0dHJpYnV0ZXMgPSB0aGlzLnVwZGF0ZWRBdHRyaWJ1dGVzO1xuICAgIGlmIChpc0VtcHR5KHVwZGF0ZWRBdHRyaWJ1dGVzKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUtuZXhRdWVyeSgpXG4gICAgICAudXBkYXRlKHVwZGF0ZWRBdHRyaWJ1dGVzKVxuICAgICAgLndoZXJlKHsgW3RoaXMuY29uc3RydWN0b3IuaWRBdHRyaWJ1dGVdOiB0aGlzLmlkIH0pO1xuICAgIHRoaXMucHJldmlvdXNBdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzO1xuICB9XG5cbiAgYXN5bmMgbG9hZChyZWxhdGlvbikge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzW3JlbGF0aW9uXSgpO1xuICAgIHRoaXMuc2V0UmVsYXRlZERhdGEocmVsYXRpb24sIGRhdGEpO1xuICB9XG59O1xuIl19
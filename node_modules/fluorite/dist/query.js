'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.MultipleRowsQuery = exports.SingleRowQuery = undefined;

var _asyncIterator2 = require('babel-runtime/helpers/asyncIterator');

var _asyncIterator3 = _interopRequireDefault(_asyncIterator2);

var _asyncGenerator2 = require('babel-runtime/helpers/asyncGenerator');

var _asyncGenerator3 = _interopRequireDefault(_asyncGenerator2);

var _symbol = require('babel-runtime/core-js/symbol');

var _symbol2 = _interopRequireDefault(_symbol);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _lodash = require('lodash');

var _streamToAsyncIterator = require('stream-to-async-iterator');

var _streamToAsyncIterator2 = _interopRequireDefault(_streamToAsyncIterator);

var _filter = require('./filter');

var _filter2 = _interopRequireDefault(_filter);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var getValue = function getValue(qb) {
  return qb.first().then(function (row) {
    return (0, _lodash.first)((0, _values2.default)(row));
  });
}; /*
    * Copyright (c) 2017 Roman Lakhtadyr
    *
    * Permission is hereby granted, free of charge, to any person obtaining a copy
    * of this software and associated documentation files (the "Software"), to deal
    * in the Software without restriction, including without limitation the rights
    * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    * copies of the Software, and to permit persons to whom the Software is
    * furnished to do so, subject to the following conditions:
    *
    * The above copyright notice and this permission notice shall be included in all
    * copies or substantial portions of the Software.
    *
    * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    * SOFTWARE.
    */

var BaseQuery = function () {
  function BaseQuery(modelClass) {
    var filters = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
    var relationNames = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
    (0, _classCallCheck3.default)(this, BaseQuery);

    this.modelClass = modelClass;
    this.filters = filters;
    this.relationNames = relationNames;
    this.fluorite = modelClass.fluorite;
    this.transaction = this.fluorite.transaction;

    this.applyScopes();

    this.then = this.modelClass.fluorite.ns.bind(this.then);
  }

  (0, _createClass3.default)(BaseQuery, [{
    key: 'applyScopes',
    value: function applyScopes() {
      var _this = this;

      var _loop = function _loop(property) {
        var scope = _this.modelClass.scopes[property];
        _this[property] = function () {
          for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
            args[_key] = arguments[_key];
          }

          return scope.apply(undefined, [_this].concat(args));
        };
      };

      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = (0, _getIterator3.default)((0, _keys2.default)(this.modelClass.scopes)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var property = _step.value;

          _loop(property);
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    }
  }, {
    key: 'makeModel',
    value: function makeModel(rowData) {
      return this.fluorite.wrapModel(rowData, this.modelClass);
    }
  }, {
    key: 'prepareQuery',
    value: function prepareQuery() {
      var knexQuery = this.knexQueryTransacting();
      this.filters.forEach(function (f) {
        return f(knexQuery);
      });
      return knexQuery;
    }
  }, {
    key: 'knexQueryTransacting',
    value: function knexQueryTransacting() {
      if (this.transaction.isTransacting()) {
        return this.transaction.currentTransaction().from(this.modelClass.table);
      }

      return this.modelClass.knex(this.modelClass.table);
    }
  }, {
    key: 'filter',
    value: function filter(attributes) {
      return this.query((0, _filter2.default)(attributes, this.modelClass.table));
    }
  }, {
    key: 'query',
    value: function query(callback) {
      return new this.constructor(this.modelClass, [].concat((0, _toConsumableArray3.default)(this.filters), [callback]), this.relationNames);
    }
  }, {
    key: 'including',
    value: function including() {
      for (var _len2 = arguments.length, relationNames = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        relationNames[_key2] = arguments[_key2];
      }

      return new this.constructor(this.modelClass, this.filters, [].concat((0, _toConsumableArray3.default)(this.relationNames), relationNames));
    }
  }, {
    key: 'toString',
    value: function toString() {
      return this.prepareQuery().toString();
    }
  }, {
    key: 'limit',
    value: function limit(number) {
      return this.query(function (q) {
        return q.limit(number);
      });
    }
  }, {
    key: 'offset',
    value: function offset(number) {
      return this.query(function (q) {
        return q.offset(number);
      });
    }
  }, {
    key: 'orderBy',
    value: function orderBy(column, direction) {
      return this.query(function (q) {
        return q.orderBy(column, direction);
      });
    }
  }, {
    key: 'create',
    value: function () {
      var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(attributes) {
        var model;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                model = this.modelClass.create(attributes);
                _context.next = 3;
                return model.save();

              case 3:
                return _context.abrupt('return', model);

              case 4:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function create(_x3) {
        return _ref.apply(this, arguments);
      }

      return create;
    }()
  }, {
    key: 'update',
    value: function () {
      var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(attributes) {
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                _context2.next = 2;
                return this.prepareQuery().update(attributes);

              case 2:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function update(_x4) {
        return _ref2.apply(this, arguments);
      }

      return update;
    }()
  }, {
    key: 'remove',
    value: function () {
      var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3() {
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.next = 2;
                return this.prepareQuery().delete();

              case 2:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function remove() {
        return _ref3.apply(this, arguments);
      }

      return remove;
    }()
  }, {
    key: 'prepareSelectQuery',
    value: function () {
      var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4() {
        var query;
        return _regenerator2.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                query = this.prepareQuery();

                query.select(this.modelClass.table + '.*');
                return _context4.abrupt('return', query);

              case 3:
              case 'end':
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));

      function prepareSelectQuery() {
        return _ref4.apply(this, arguments);
      }

      return prepareSelectQuery;
    }()
  }, {
    key: 'createModels',
    value: function () {
      var _ref5 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5(rowData) {
        var ModelClass, models;
        return _regenerator2.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                if (!(rowData.length === 0)) {
                  _context5.next = 2;
                  break;
                }

                return _context5.abrupt('return', []);

              case 2:
                ModelClass = this.modelClass;
                models = rowData.map(function (row) {
                  return new ModelClass(row, (0, _assign2.default)({}, row));
                });
                _context5.next = 6;
                return _promise2.default.all(this.relationNames.map(function (name) {
                  var _name$split = name.split('.', 2),
                      _name$split2 = (0, _slicedToArray3.default)(_name$split, 2),
                      head = _name$split2[0],
                      tail = _name$split2[1];

                  var relation = (0, _lodash.first)(models)[head]();
                  return relation.extractRelatedData(rowData, head, models, tail);
                }));

              case 6:
                return _context5.abrupt('return', models);

              case 7:
              case 'end':
                return _context5.stop();
            }
          }
        }, _callee5, this);
      }));

      function createModels(_x5) {
        return _ref5.apply(this, arguments);
      }

      return createModels;
    }()

    // eslint-disable-next-line class-methods-use-this

  }, {
    key: 'eval',
    value: function () {
      var _ref6 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6() {
        return _regenerator2.default.wrap(function _callee6$(_context6) {
          while (1) {
            switch (_context6.prev = _context6.next) {
              case 0:
                throw new Error('Method not implemented');

              case 1:
              case 'end':
                return _context6.stop();
            }
          }
        }, _callee6, this);
      }));

      function _eval() {
        return _ref6.apply(this, arguments);
      }

      return _eval;
    }()
  }, {
    key: 'then',
    value: function () {
      var _ref7 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee7(resolve, reject) {
        var result;
        return _regenerator2.default.wrap(function _callee7$(_context7) {
          while (1) {
            switch (_context7.prev = _context7.next) {
              case 0:
                _context7.prev = 0;
                _context7.next = 3;
                return this.eval();

              case 3:
                result = _context7.sent;
                return _context7.abrupt('return', resolve(result));

              case 7:
                _context7.prev = 7;
                _context7.t0 = _context7['catch'](0);
                return _context7.abrupt('return', reject(_context7.t0));

              case 10:
              case 'end':
                return _context7.stop();
            }
          }
        }, _callee7, this, [[0, 7]]);
      }));

      function then(_x6, _x7) {
        return _ref7.apply(this, arguments);
      }

      return then;
    }()
  }, {
    key: 'catch',
    value: function () {
      var _ref8 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee8(reject) {
        return _regenerator2.default.wrap(function _callee8$(_context8) {
          while (1) {
            switch (_context8.prev = _context8.next) {
              case 0:
                return _context8.abrupt('return', this.then(_lodash.identity, reject));

              case 1:
              case 'end':
                return _context8.stop();
            }
          }
        }, _callee8, this);
      }));

      function _catch(_x8) {
        return _ref8.apply(this, arguments);
      }

      return _catch;
    }()
  }]);
  return BaseQuery;
}();

var SingleRowQuery = exports.SingleRowQuery = function (_BaseQuery) {
  (0, _inherits3.default)(SingleRowQuery, _BaseQuery);

  function SingleRowQuery() {
    (0, _classCallCheck3.default)(this, SingleRowQuery);
    return (0, _possibleConstructorReturn3.default)(this, (SingleRowQuery.__proto__ || (0, _getPrototypeOf2.default)(SingleRowQuery)).apply(this, arguments));
  }

  (0, _createClass3.default)(SingleRowQuery, [{
    key: 'eval',
    value: function () {
      var _ref9 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee9() {
        var query, rowData;
        return _regenerator2.default.wrap(function _callee9$(_context9) {
          while (1) {
            switch (_context9.prev = _context9.next) {
              case 0:
                query = this.prepareSelectQuery();
                _context9.next = 3;
                return query;

              case 3:
                rowData = _context9.sent;

                if (!(rowData.length === 1)) {
                  _context9.next = 6;
                  break;
                }

                return _context9.abrupt('return', this.createModels(rowData).then(function (models) {
                  return (0, _lodash.first)(models);
                }));

              case 6:
                if (!(rowData.length === 0)) {
                  _context9.next = 8;
                  break;
                }

                throw new this.modelClass.NotFoundError('Entity not found');

              case 8:
                throw new this.modelClass.IntegrityError('More than one entity returned');

              case 9:
              case 'end':
                return _context9.stop();
            }
          }
        }, _callee9, this);
      }));

      function _eval() {
        return _ref9.apply(this, arguments);
      }

      return _eval;
    }()
  }]);
  return SingleRowQuery;
}(BaseQuery);

var MultipleRowsQuery = exports.MultipleRowsQuery = function (_BaseQuery2) {
  (0, _inherits3.default)(MultipleRowsQuery, _BaseQuery2);

  function MultipleRowsQuery() {
    (0, _classCallCheck3.default)(this, MultipleRowsQuery);
    return (0, _possibleConstructorReturn3.default)(this, (MultipleRowsQuery.__proto__ || (0, _getPrototypeOf2.default)(MultipleRowsQuery)).apply(this, arguments));
  }

  (0, _createClass3.default)(MultipleRowsQuery, [{
    key: 'count',
    value: function count() {
      var column = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;

      return getValue(this.prepareQuery().count(column));
    }
  }, {
    key: 'min',
    value: function min(column) {
      return getValue(this.prepareQuery().min(column));
    }
  }, {
    key: 'max',
    value: function max(column) {
      return getValue(this.prepareQuery().max(column));
    }
  }, {
    key: 'sum',
    value: function sum(column) {
      return getValue(this.prepareQuery().sum(column));
    }
  }, {
    key: 'avg',
    value: function avg(column) {
      return getValue(this.prepareQuery().avg(column));
    }
  }, {
    key: 'pluck',
    value: function pluck(column) {
      return this.prepareQuery().pluck(column);
    }
  }, {
    key: 'single',
    value: function single() {
      var attributes = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

      if (!(0, _lodash.isEmpty)(attributes)) {
        return this.filter(attributes).single();
      }

      return new SingleRowQuery(this.modelClass, this.filters);
    }
  }, {
    key: 'first',
    value: function first() {
      var attributes = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

      return this.single(attributes).limit(1);
    }
  }, {
    key: 'eval',
    value: function () {
      var _ref10 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee10() {
        var query, rowData;
        return _regenerator2.default.wrap(function _callee10$(_context10) {
          while (1) {
            switch (_context10.prev = _context10.next) {
              case 0:
                query = this.prepareSelectQuery();
                _context10.next = 3;
                return query;

              case 3:
                rowData = _context10.sent;
                return _context10.abrupt('return', this.createModels(rowData));

              case 5:
              case 'end':
                return _context10.stop();
            }
          }
        }, _callee10, this);
      }));

      function _eval() {
        return _ref10.apply(this, arguments);
      }

      return _eval;
    }()
  }, {
    key: _symbol2.default.asyncIterator,
    value: function value() {
      var query = this.prepareSelectQuery();

      return function () {
        var _ref11 = _asyncGenerator3.default.wrap(_regenerator2.default.mark(function _callee11() {
          var _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, _value, rowData;

          return _regenerator2.default.wrap(function _callee11$(_context11) {
            while (1) {
              switch (_context11.prev = _context11.next) {
                case 0:
                  _iteratorNormalCompletion2 = true;
                  _didIteratorError2 = false;
                  _iteratorError2 = undefined;
                  _context11.prev = 3;
                  _iterator2 = (0, _asyncIterator3.default)(new _streamToAsyncIterator2.default(query.stream()));

                case 5:
                  _context11.next = 7;
                  return _asyncGenerator3.default.await(_iterator2.next());

                case 7:
                  _step2 = _context11.sent;
                  _iteratorNormalCompletion2 = _step2.done;
                  _context11.next = 11;
                  return _asyncGenerator3.default.await(_step2.value);

                case 11:
                  _value = _context11.sent;

                  if (_iteratorNormalCompletion2) {
                    _context11.next = 19;
                    break;
                  }

                  rowData = _value;
                  _context11.next = 16;
                  return this.makeModel(rowData);

                case 16:
                  _iteratorNormalCompletion2 = true;
                  _context11.next = 5;
                  break;

                case 19:
                  _context11.next = 25;
                  break;

                case 21:
                  _context11.prev = 21;
                  _context11.t0 = _context11['catch'](3);
                  _didIteratorError2 = true;
                  _iteratorError2 = _context11.t0;

                case 25:
                  _context11.prev = 25;
                  _context11.prev = 26;

                  if (!(!_iteratorNormalCompletion2 && _iterator2.return)) {
                    _context11.next = 30;
                    break;
                  }

                  _context11.next = 30;
                  return _asyncGenerator3.default.await(_iterator2.return());

                case 30:
                  _context11.prev = 30;

                  if (!_didIteratorError2) {
                    _context11.next = 33;
                    break;
                  }

                  throw _iteratorError2;

                case 33:
                  return _context11.finish(30);

                case 34:
                  return _context11.finish(25);

                case 35:
                case 'end':
                  return _context11.stop();
              }
            }
          }, _callee11, this, [[3, 21, 25, 35], [26,, 30, 34]]);
        }));

        function asyncIterator() {
          return _ref11.apply(this, arguments);
        }

        return asyncIterator;
      }().bind(this);
    }
  }]);
  return MultipleRowsQuery;
}(BaseQuery);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9xdWVyeS5qcyJdLCJuYW1lcyI6WyJnZXRWYWx1ZSIsInFiIiwiZmlyc3QiLCJ0aGVuIiwicm93IiwiQmFzZVF1ZXJ5IiwibW9kZWxDbGFzcyIsImZpbHRlcnMiLCJyZWxhdGlvbk5hbWVzIiwiZmx1b3JpdGUiLCJ0cmFuc2FjdGlvbiIsImFwcGx5U2NvcGVzIiwibnMiLCJiaW5kIiwicHJvcGVydHkiLCJzY29wZSIsInNjb3BlcyIsImFyZ3MiLCJyb3dEYXRhIiwid3JhcE1vZGVsIiwia25leFF1ZXJ5Iiwia25leFF1ZXJ5VHJhbnNhY3RpbmciLCJmb3JFYWNoIiwiZiIsImlzVHJhbnNhY3RpbmciLCJjdXJyZW50VHJhbnNhY3Rpb24iLCJmcm9tIiwidGFibGUiLCJrbmV4IiwiYXR0cmlidXRlcyIsInF1ZXJ5IiwiY2FsbGJhY2siLCJjb25zdHJ1Y3RvciIsInByZXBhcmVRdWVyeSIsInRvU3RyaW5nIiwibnVtYmVyIiwicSIsImxpbWl0Iiwib2Zmc2V0IiwiY29sdW1uIiwiZGlyZWN0aW9uIiwib3JkZXJCeSIsIm1vZGVsIiwiY3JlYXRlIiwic2F2ZSIsInVwZGF0ZSIsImRlbGV0ZSIsInNlbGVjdCIsImxlbmd0aCIsIk1vZGVsQ2xhc3MiLCJtb2RlbHMiLCJtYXAiLCJhbGwiLCJuYW1lIiwic3BsaXQiLCJoZWFkIiwidGFpbCIsInJlbGF0aW9uIiwiZXh0cmFjdFJlbGF0ZWREYXRhIiwiRXJyb3IiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXZhbCIsInJlc3VsdCIsIlNpbmdsZVJvd1F1ZXJ5IiwicHJlcGFyZVNlbGVjdFF1ZXJ5IiwiY3JlYXRlTW9kZWxzIiwiTm90Rm91bmRFcnJvciIsIkludGVncml0eUVycm9yIiwiTXVsdGlwbGVSb3dzUXVlcnkiLCJjb3VudCIsIm1pbiIsIm1heCIsInN1bSIsImF2ZyIsInBsdWNrIiwiZmlsdGVyIiwic2luZ2xlIiwiYXN5bmNJdGVyYXRvciIsInN0cmVhbSIsIm1ha2VNb2RlbCJdLCJtYXBwaW5ncyI6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MjAxNyBSb21hbiBMYWtodGFkeXJcbiAqXG4gKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4gKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4gKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4gKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsXG4gKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEVcbiAqIFNPRlRXQVJFLlxuICovXG5cbmltcG9ydCB7IGZpcnN0LCBpc0VtcHR5LCBpZGVudGl0eSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgU3RyZWFtVG9Bc3luYyBmcm9tICdzdHJlYW0tdG8tYXN5bmMtaXRlcmF0b3InO1xuaW1wb3J0IGZpbHRlclF1ZXJ5IGZyb20gJy4vZmlsdGVyJztcblxuY29uc3QgZ2V0VmFsdWUgPSBxYiA9PiAoXG4gIHFiLmZpcnN0KCkudGhlbihyb3cgPT4gZmlyc3QoT2JqZWN0LnZhbHVlcyhyb3cpKSlcbik7XG5cbmNsYXNzIEJhc2VRdWVyeSB7XG4gIGNvbnN0cnVjdG9yKG1vZGVsQ2xhc3MsIGZpbHRlcnMgPSBbXSwgcmVsYXRpb25OYW1lcyA9IFtdKSB7XG4gICAgdGhpcy5tb2RlbENsYXNzID0gbW9kZWxDbGFzcztcbiAgICB0aGlzLmZpbHRlcnMgPSBmaWx0ZXJzO1xuICAgIHRoaXMucmVsYXRpb25OYW1lcyA9IHJlbGF0aW9uTmFtZXM7XG4gICAgdGhpcy5mbHVvcml0ZSA9IG1vZGVsQ2xhc3MuZmx1b3JpdGU7XG4gICAgdGhpcy50cmFuc2FjdGlvbiA9IHRoaXMuZmx1b3JpdGUudHJhbnNhY3Rpb247XG5cbiAgICB0aGlzLmFwcGx5U2NvcGVzKCk7XG5cbiAgICB0aGlzLnRoZW4gPSB0aGlzLm1vZGVsQ2xhc3MuZmx1b3JpdGUubnMuYmluZCh0aGlzLnRoZW4pO1xuICB9XG5cbiAgYXBwbHlTY29wZXMoKSB7XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBPYmplY3Qua2V5cyh0aGlzLm1vZGVsQ2xhc3Muc2NvcGVzKSkge1xuICAgICAgY29uc3Qgc2NvcGUgPSB0aGlzLm1vZGVsQ2xhc3Muc2NvcGVzW3Byb3BlcnR5XTtcbiAgICAgIHRoaXNbcHJvcGVydHldID0gKC4uLmFyZ3MpID0+IHNjb3BlKHRoaXMsIC4uLmFyZ3MpO1xuICAgIH1cbiAgfVxuXG4gIG1ha2VNb2RlbChyb3dEYXRhKSB7XG4gICAgcmV0dXJuIHRoaXMuZmx1b3JpdGUud3JhcE1vZGVsKHJvd0RhdGEsIHRoaXMubW9kZWxDbGFzcyk7XG4gIH1cblxuICBwcmVwYXJlUXVlcnkoKSB7XG4gICAgY29uc3Qga25leFF1ZXJ5ID0gdGhpcy5rbmV4UXVlcnlUcmFuc2FjdGluZygpO1xuICAgIHRoaXMuZmlsdGVycy5mb3JFYWNoKGYgPT4gZihrbmV4UXVlcnkpKTtcbiAgICByZXR1cm4ga25leFF1ZXJ5O1xuICB9XG5cbiAga25leFF1ZXJ5VHJhbnNhY3RpbmcoKSB7XG4gICAgaWYgKHRoaXMudHJhbnNhY3Rpb24uaXNUcmFuc2FjdGluZygpKSB7XG4gICAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbi5jdXJyZW50VHJhbnNhY3Rpb24oKS5mcm9tKHRoaXMubW9kZWxDbGFzcy50YWJsZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubW9kZWxDbGFzcy5rbmV4KHRoaXMubW9kZWxDbGFzcy50YWJsZSk7XG4gIH1cblxuICBmaWx0ZXIoYXR0cmlidXRlcykge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5KGZpbHRlclF1ZXJ5KGF0dHJpYnV0ZXMsIHRoaXMubW9kZWxDbGFzcy50YWJsZSkpO1xuICB9XG5cbiAgcXVlcnkoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoXG4gICAgICB0aGlzLm1vZGVsQ2xhc3MsIFsuLi50aGlzLmZpbHRlcnMsIGNhbGxiYWNrXSwgdGhpcy5yZWxhdGlvbk5hbWVzLFxuICAgICk7XG4gIH1cblxuICBpbmNsdWRpbmcoLi4ucmVsYXRpb25OYW1lcykge1xuICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcihcbiAgICAgIHRoaXMubW9kZWxDbGFzcywgdGhpcy5maWx0ZXJzLCBbLi4udGhpcy5yZWxhdGlvbk5hbWVzLCAuLi5yZWxhdGlvbk5hbWVzXSxcbiAgICApO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJlcGFyZVF1ZXJ5KCkudG9TdHJpbmcoKTtcbiAgfVxuXG4gIGxpbWl0KG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5KHEgPT4gcS5saW1pdChudW1iZXIpKTtcbiAgfVxuXG4gIG9mZnNldChudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5xdWVyeShxID0+IHEub2Zmc2V0KG51bWJlcikpO1xuICB9XG5cbiAgb3JkZXJCeShjb2x1bW4sIGRpcmVjdGlvbikge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5KHEgPT4gcS5vcmRlckJ5KGNvbHVtbiwgZGlyZWN0aW9uKSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGUoYXR0cmlidXRlcykge1xuICAgIGNvbnN0IG1vZGVsID0gdGhpcy5tb2RlbENsYXNzLmNyZWF0ZShhdHRyaWJ1dGVzKTtcbiAgICBhd2FpdCBtb2RlbC5zYXZlKCk7XG4gICAgcmV0dXJuIG1vZGVsO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlKGF0dHJpYnV0ZXMpIHtcbiAgICBhd2FpdCB0aGlzLnByZXBhcmVRdWVyeSgpLnVwZGF0ZShhdHRyaWJ1dGVzKTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZSgpIHtcbiAgICBhd2FpdCB0aGlzLnByZXBhcmVRdWVyeSgpLmRlbGV0ZSgpO1xuICB9XG5cbiAgYXN5bmMgcHJlcGFyZVNlbGVjdFF1ZXJ5KCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5wcmVwYXJlUXVlcnkoKTtcbiAgICBxdWVyeS5zZWxlY3QoYCR7dGhpcy5tb2RlbENsYXNzLnRhYmxlfS4qYCk7XG4gICAgcmV0dXJuIHF1ZXJ5O1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlTW9kZWxzKHJvd0RhdGEpIHtcbiAgICBpZiAocm93RGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCBNb2RlbENsYXNzID0gdGhpcy5tb2RlbENsYXNzO1xuICAgIGNvbnN0IG1vZGVscyA9IHJvd0RhdGEubWFwKFxuICAgICAgcm93ID0+IG5ldyBNb2RlbENsYXNzKHJvdywgT2JqZWN0LmFzc2lnbih7fSwgcm93KSksXG4gICAgKTtcblxuICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucmVsYXRpb25OYW1lcy5tYXAoKG5hbWUpID0+IHtcbiAgICAgIGNvbnN0IFtoZWFkLCB0YWlsXSA9IG5hbWUuc3BsaXQoJy4nLCAyKTtcbiAgICAgIGNvbnN0IHJlbGF0aW9uID0gZmlyc3QobW9kZWxzKVtoZWFkXSgpO1xuICAgICAgcmV0dXJuIHJlbGF0aW9uLmV4dHJhY3RSZWxhdGVkRGF0YShyb3dEYXRhLCBoZWFkLCBtb2RlbHMsIHRhaWwpO1xuICAgIH0pKTtcblxuICAgIHJldHVybiBtb2RlbHM7XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2xhc3MtbWV0aG9kcy11c2UtdGhpc1xuICBhc3luYyBldmFsKCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgYXN5bmMgdGhlbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5ldmFsKCk7XG4gICAgICByZXR1cm4gcmVzb2x2ZShyZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiByZWplY3QoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2F0Y2gocmVqZWN0KSB7XG4gICAgcmV0dXJuIHRoaXMudGhlbihpZGVudGl0eSwgcmVqZWN0KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2luZ2xlUm93UXVlcnkgZXh0ZW5kcyBCYXNlUXVlcnkge1xuICBhc3luYyBldmFsKCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5wcmVwYXJlU2VsZWN0UXVlcnkoKTtcblxuICAgIGNvbnN0IHJvd0RhdGEgPSBhd2FpdCBxdWVyeTtcblxuICAgIGlmIChyb3dEYXRhLmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlTW9kZWxzKHJvd0RhdGEpXG4gICAgICAgIC50aGVuKG1vZGVscyA9PiBmaXJzdChtb2RlbHMpKTtcbiAgICB9XG5cbiAgICBpZiAocm93RGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyB0aGlzLm1vZGVsQ2xhc3MuTm90Rm91bmRFcnJvcignRW50aXR5IG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIHRocm93IG5ldyB0aGlzLm1vZGVsQ2xhc3MuSW50ZWdyaXR5RXJyb3IoJ01vcmUgdGhhbiBvbmUgZW50aXR5IHJldHVybmVkJyk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE11bHRpcGxlUm93c1F1ZXJ5IGV4dGVuZHMgQmFzZVF1ZXJ5IHtcbiAgY291bnQoY29sdW1uID0gbnVsbCkge1xuICAgIHJldHVybiBnZXRWYWx1ZSh0aGlzLnByZXBhcmVRdWVyeSgpLmNvdW50KGNvbHVtbikpO1xuICB9XG5cbiAgbWluKGNvbHVtbikge1xuICAgIHJldHVybiBnZXRWYWx1ZSh0aGlzLnByZXBhcmVRdWVyeSgpLm1pbihjb2x1bW4pKTtcbiAgfVxuXG4gIG1heChjb2x1bW4pIHtcbiAgICByZXR1cm4gZ2V0VmFsdWUodGhpcy5wcmVwYXJlUXVlcnkoKS5tYXgoY29sdW1uKSk7XG4gIH1cblxuICBzdW0oY29sdW1uKSB7XG4gICAgcmV0dXJuIGdldFZhbHVlKHRoaXMucHJlcGFyZVF1ZXJ5KCkuc3VtKGNvbHVtbikpO1xuICB9XG5cbiAgYXZnKGNvbHVtbikge1xuICAgIHJldHVybiBnZXRWYWx1ZSh0aGlzLnByZXBhcmVRdWVyeSgpLmF2Zyhjb2x1bW4pKTtcbiAgfVxuXG4gIHBsdWNrKGNvbHVtbikge1xuICAgIHJldHVybiB0aGlzLnByZXBhcmVRdWVyeSgpLnBsdWNrKGNvbHVtbik7XG4gIH1cblxuICBzaW5nbGUoYXR0cmlidXRlcyA9IHt9KSB7XG4gICAgaWYgKCFpc0VtcHR5KGF0dHJpYnV0ZXMpKSB7XG4gICAgICByZXR1cm4gdGhpcy5maWx0ZXIoYXR0cmlidXRlcykuc2luZ2xlKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBTaW5nbGVSb3dRdWVyeSh0aGlzLm1vZGVsQ2xhc3MsIHRoaXMuZmlsdGVycyk7XG4gIH1cblxuICBmaXJzdChhdHRyaWJ1dGVzID0ge30pIHtcbiAgICByZXR1cm4gdGhpcy5zaW5nbGUoYXR0cmlidXRlcykubGltaXQoMSk7XG4gIH1cblxuICBhc3luYyBldmFsKCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5wcmVwYXJlU2VsZWN0UXVlcnkoKTtcblxuICAgIGNvbnN0IHJvd0RhdGEgPSBhd2FpdCBxdWVyeTtcblxuICAgIHJldHVybiB0aGlzLmNyZWF0ZU1vZGVscyhyb3dEYXRhKTtcbiAgfVxuXG4gIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLnByZXBhcmVTZWxlY3RRdWVyeSgpO1xuXG4gICAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uKiBhc3luY0l0ZXJhdG9yKCkge1xuICAgICAgZm9yIGF3YWl0IChjb25zdCByb3dEYXRhIG9mIG5ldyBTdHJlYW1Ub0FzeW5jKHF1ZXJ5LnN0cmVhbSgpKSkge1xuICAgICAgICB5aWVsZCB0aGlzLm1ha2VNb2RlbChyb3dEYXRhKTtcbiAgICAgIH1cbiAgICB9LmJpbmQodGhpcyk7XG4gIH1cbn1cbiJdfQ==
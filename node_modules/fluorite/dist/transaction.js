'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright (c) 2017 Roman Lakhtadyr
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

exports.default = function (knex, ns) {
  return {
    transaction: function transaction(callback) {
      var _this = this;

      return knex.transaction(function (trx) {
        return ns.runAndReturn((0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee() {
          return _regenerator2.default.wrap(function _callee$(_context) {
            while (1) {
              switch (_context.prev = _context.next) {
                case 0:
                  ns.set('trx', trx);
                  return _context.abrupt('return', callback());

                case 2:
                case 'end':
                  return _context.stop();
              }
            }
          }, _callee, _this);
        })));
      });
    },
    isTransacting: function isTransacting() {
      return ns.get('trx') !== undefined;
    },
    currentTransaction: function currentTransaction() {
      return ns.get('trx');
    }
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmFuc2FjdGlvbi5qcyJdLCJuYW1lcyI6WyJrbmV4IiwibnMiLCJ0cmFuc2FjdGlvbiIsImNhbGxiYWNrIiwicnVuQW5kUmV0dXJuIiwic2V0IiwidHJ4IiwiaXNUcmFuc2FjdGluZyIsImdldCIsInVuZGVmaW5lZCIsImN1cnJlbnRUcmFuc2FjdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2tCQXNCZSxVQUFDQSxJQUFELEVBQU9DLEVBQVA7QUFBQSxTQUFlO0FBQzVCQyxlQUQ0Qix1QkFDaEJDLFFBRGdCLEVBQ047QUFBQTs7QUFDcEIsYUFBT0gsS0FBS0UsV0FBTCxDQUFpQjtBQUFBLGVBQ3RCRCxHQUFHRyxZQUFILDREQUFnQjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQ2RILHFCQUFHSSxHQUFILENBQU8sS0FBUCxFQUFjQyxHQUFkO0FBRGMsbURBRVBILFVBRk87O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsU0FBaEIsR0FEc0I7QUFBQSxPQUFqQixDQUFQO0FBTUQsS0FSMkI7QUFTNUJJLGlCQVQ0QiwyQkFTWjtBQUNkLGFBQU9OLEdBQUdPLEdBQUgsQ0FBTyxLQUFQLE1BQWtCQyxTQUF6QjtBQUNELEtBWDJCO0FBWTVCQyxzQkFaNEIsZ0NBWVA7QUFDbkIsYUFBT1QsR0FBR08sR0FBSCxDQUFPLEtBQVAsQ0FBUDtBQUNEO0FBZDJCLEdBQWY7QUFBQSxDIiwiZmlsZSI6InRyYW5zYWN0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAxNyBSb21hbiBMYWtodGFkeXJcbiAqXG4gKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4gKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4gKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4gKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsXG4gKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEVcbiAqIFNPRlRXQVJFLlxuICovXG5cbmV4cG9ydCBkZWZhdWx0IChrbmV4LCBucykgPT4gKHtcbiAgdHJhbnNhY3Rpb24oY2FsbGJhY2spIHtcbiAgICByZXR1cm4ga25leC50cmFuc2FjdGlvbih0cnggPT4gKFxuICAgICAgbnMucnVuQW5kUmV0dXJuKGFzeW5jICgpID0+IHtcbiAgICAgICAgbnMuc2V0KCd0cngnLCB0cngpO1xuICAgICAgICByZXR1cm4gY2FsbGJhY2soKTtcbiAgICAgIH0pXG4gICAgKSk7XG4gIH0sXG4gIGlzVHJhbnNhY3RpbmcoKSB7XG4gICAgcmV0dXJuIG5zLmdldCgndHJ4JykgIT09IHVuZGVmaW5lZDtcbiAgfSxcbiAgY3VycmVudFRyYW5zYWN0aW9uKCkge1xuICAgIHJldHVybiBucy5nZXQoJ3RyeCcpO1xuICB9LFxufSk7XG4iXX0=
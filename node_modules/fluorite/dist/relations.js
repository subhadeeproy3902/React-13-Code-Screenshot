'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.BelongsToMany = exports.HasMany = exports.BelongsTo = undefined;

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _defineProperty2 = require('babel-runtime/helpers/defineProperty');

var _defineProperty3 = _interopRequireDefault(_defineProperty2);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _lodash = require('lodash');

var _query = require('./query');

var _unsafe = require('./util/unsafe');

var unsafe = _interopRequireWildcard(_unsafe);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BelongsTo = exports.BelongsTo = function (_SingleRowQuery) {
  (0, _inherits3.default)(BelongsTo, _SingleRowQuery);

  function BelongsTo(sourceEntity, relatedClass, foreignKey, foreignKeyTarget) {
    (0, _classCallCheck3.default)(this, BelongsTo);

    var _this = (0, _possibleConstructorReturn3.default)(this, (BelongsTo.__proto__ || (0, _getPrototypeOf2.default)(BelongsTo)).call(this, relatedClass, [function (qb) {
      return qb.where((0, _defineProperty3.default)({}, foreignKeyTarget, sourceEntity.get(foreignKey)));
    }]));

    _this.foreignKey = foreignKey;
    _this.foreignKeyTarget = foreignKeyTarget;
    return _this;
  }

  (0, _createClass3.default)(BelongsTo, [{
    key: 'query',
    value: function query(callback) {
      return new _query.SingleRowQuery(this.modelClass, [].concat((0, _toConsumableArray3.default)(this.filters), [callback]), this.relationNames);
    }
  }, {
    key: 'including',
    value: function including() {
      for (var _len = arguments.length, relationNames = Array(_len), _key = 0; _key < _len; _key++) {
        relationNames[_key] = arguments[_key];
      }

      return new _query.SingleRowQuery(this.modelClass, this.filters, [].concat((0, _toConsumableArray3.default)(this.relationNames), relationNames));
    }
  }, {
    key: 'extractRelatedData',
    value: function () {
      var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(rowData, relationName, models, nestedRelations) {
        var that, ids, query, relatedModels;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                that = this;
                ids = rowData.map(function (row) {
                  return row[that.foreignKey];
                });
                query = this.modelClass.objects().filter({ id__in: ids });


                if (nestedRelations) {
                  query = query.including(nestedRelations);
                }

                _context.next = 6;
                return query;

              case 6:
                relatedModels = _context.sent;


                models.map(function (model) {
                  var relatedModel = (0, _lodash.find)(relatedModels, function (m) {
                    return unsafe.eq(m.get(that.foreignKeyTarget), model.id);
                  });
                  return model.setRelatedData(relationName, relatedModel);
                });

                return _context.abrupt('return', rowData);

              case 9:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function extractRelatedData(_x, _x2, _x3, _x4) {
        return _ref.apply(this, arguments);
      }

      return extractRelatedData;
    }()
  }]);
  return BelongsTo;
}(_query.SingleRowQuery); /*
                           * Copyright (c) 2017 Roman Lakhtadyr
                           *
                           * Permission is hereby granted, free of charge, to any person obtaining a copy
                           * of this software and associated documentation files (the "Software"), to deal
                           * in the Software without restriction, including without limitation the rights
                           * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                           * copies of the Software, and to permit persons to whom the Software is
                           * furnished to do so, subject to the following conditions:
                           *
                           * The above copyright notice and this permission notice shall be included in all
                           * copies or substantial portions of the Software.
                           *
                           * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                           * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                           * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                           * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                           * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                           * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
                           * SOFTWARE.
                           */

var HasMany = exports.HasMany = function (_MultipleRowsQuery) {
  (0, _inherits3.default)(HasMany, _MultipleRowsQuery);

  function HasMany(sourceEntity, relatedClass, foreignKey, foreignKeyTarget) {
    (0, _classCallCheck3.default)(this, HasMany);

    var _this2 = (0, _possibleConstructorReturn3.default)(this, (HasMany.__proto__ || (0, _getPrototypeOf2.default)(HasMany)).call(this, relatedClass, [function (qb) {
      return qb.where((0, _defineProperty3.default)({}, foreignKey, sourceEntity.get(foreignKeyTarget)));
    }]));

    _this2.foreignKey = foreignKey;
    return _this2;
  }

  (0, _createClass3.default)(HasMany, [{
    key: 'query',
    value: function query(callback) {
      return new _query.MultipleRowsQuery(this.modelClass, [].concat((0, _toConsumableArray3.default)(this.filters), [callback]), this.relationNames);
    }
  }, {
    key: 'including',
    value: function including() {
      for (var _len2 = arguments.length, relationNames = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        relationNames[_key2] = arguments[_key2];
      }

      return new _query.MultipleRowsQuery(this.modelClass, this.filters, [].concat((0, _toConsumableArray3.default)(this.relationNames), relationNames));
    }
  }, {
    key: 'extractRelatedData',
    value: function () {
      var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(rows, relationName, models, nestedRelations) {
        var that, ids, query, relatedModels;
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                that = this;
                ids = rows.map(function (row) {
                  return row.id;
                });
                query = this.modelClass.objects().filter((0, _defineProperty3.default)({}, this.foreignKey + '__in', ids));


                if (nestedRelations) {
                  query = query.including(nestedRelations);
                }

                _context2.next = 6;
                return query;

              case 6:
                relatedModels = _context2.sent;


                models.map(function (model) {
                  var filteredModels = relatedModels.filter(function (m) {
                    return unsafe.eq(m.get(that.foreignKey), model.id);
                  });
                  return model.setRelatedData(relationName, filteredModels);
                });

                return _context2.abrupt('return', rows);

              case 9:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function extractRelatedData(_x5, _x6, _x7, _x8) {
        return _ref2.apply(this, arguments);
      }

      return extractRelatedData;
    }()
  }]);
  return HasMany;
}(_query.MultipleRowsQuery);

var BelongsToMany = exports.BelongsToMany = function (_MultipleRowsQuery2) {
  (0, _inherits3.default)(BelongsToMany, _MultipleRowsQuery2);

  function BelongsToMany(sourceEntity, relatedClass, pivotTableName, thisForeignKey, thatForeignKey, thisForeignKeyTarget, thatForeignKeyTarget) {
    (0, _classCallCheck3.default)(this, BelongsToMany);

    var _this3 = (0, _possibleConstructorReturn3.default)(this, (BelongsToMany.__proto__ || (0, _getPrototypeOf2.default)(BelongsToMany)).call(this, relatedClass, [function (qb) {
      return qb.innerJoin(pivotTableName, pivotTableName + '.' + thatForeignKey, relatedClass.table + '.' + thatForeignKeyTarget).select(relatedClass.table + '.*').where((0, _defineProperty3.default)({}, pivotTableName + '.' + thisForeignKey, sourceEntity.get(thisForeignKeyTarget)));
    }]));

    _this3.pivotTableName = pivotTableName;
    _this3.thisForeignKey = thisForeignKey;
    _this3.thatForeignKey = thatForeignKey;
    _this3.thatForeignKeyTarget = thatForeignKeyTarget;
    return _this3;
  }

  (0, _createClass3.default)(BelongsToMany, [{
    key: 'query',
    value: function query(callback) {
      return new _query.MultipleRowsQuery(this.modelClass, [].concat((0, _toConsumableArray3.default)(this.filters), [callback]), this.relationNames);
    }
  }, {
    key: 'including',
    value: function including() {
      for (var _len3 = arguments.length, relationNames = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
        relationNames[_key3] = arguments[_key3];
      }

      return new _query.MultipleRowsQuery(this.modelClass, this.filters, [].concat((0, _toConsumableArray3.default)(this.relationNames), relationNames));
    }
  }, {
    key: 'extractRelatedData',
    value: function () {
      var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3(rows, relationName, models, nestedRelations) {
        var that, ids, tempColumnName, query, relatedModels;
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                that = this;
                ids = rows.map(function (row) {
                  return row.id;
                });
                tempColumnName = '__related_id';
                query = this.modelClass.objects().query(function (qb) {
                  return qb.innerJoin(that.pivotTableName, that.pivotTableName + '.' + that.thatForeignKey, that.modelClass.table + '.' + that.thatForeignKeyTarget).whereIn(that.pivotTableName + '.' + that.thisForeignKey, ids).select(that.pivotTableName + '.' + that.thisForeignKey + ' as ' + tempColumnName);
                });


                if (nestedRelations) {
                  query = query.including(nestedRelations);
                }

                _context3.next = 7;
                return query;

              case 7:
                relatedModels = _context3.sent;


                models.map(function (model) {
                  var filteredModels = relatedModels.filter(function (m) {
                    return unsafe.eq(m.get(tempColumnName), model.id);
                  });
                  return model.setRelatedData(relationName, filteredModels);
                });

                return _context3.abrupt('return', rows);

              case 10:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function extractRelatedData(_x9, _x10, _x11, _x12) {
        return _ref3.apply(this, arguments);
      }

      return extractRelatedData;
    }()
  }]);
  return BelongsToMany;
}(_query.MultipleRowsQuery);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWxhdGlvbnMuanMiXSwibmFtZXMiOlsidW5zYWZlIiwiQmVsb25nc1RvIiwic291cmNlRW50aXR5IiwicmVsYXRlZENsYXNzIiwiZm9yZWlnbktleSIsImZvcmVpZ25LZXlUYXJnZXQiLCJxYiIsIndoZXJlIiwiZ2V0IiwiY2FsbGJhY2siLCJtb2RlbENsYXNzIiwiZmlsdGVycyIsInJlbGF0aW9uTmFtZXMiLCJyb3dEYXRhIiwicmVsYXRpb25OYW1lIiwibW9kZWxzIiwibmVzdGVkUmVsYXRpb25zIiwidGhhdCIsImlkcyIsIm1hcCIsInJvdyIsInF1ZXJ5Iiwib2JqZWN0cyIsImZpbHRlciIsImlkX19pbiIsImluY2x1ZGluZyIsInJlbGF0ZWRNb2RlbHMiLCJtb2RlbCIsInJlbGF0ZWRNb2RlbCIsImVxIiwibSIsImlkIiwic2V0UmVsYXRlZERhdGEiLCJIYXNNYW55Iiwicm93cyIsImZpbHRlcmVkTW9kZWxzIiwiQmVsb25nc1RvTWFueSIsInBpdm90VGFibGVOYW1lIiwidGhpc0ZvcmVpZ25LZXkiLCJ0aGF0Rm9yZWlnbktleSIsInRoaXNGb3JlaWduS2V5VGFyZ2V0IiwidGhhdEZvcmVpZ25LZXlUYXJnZXQiLCJpbm5lckpvaW4iLCJ0YWJsZSIsInNlbGVjdCIsInRlbXBDb2x1bW5OYW1lIiwid2hlcmVJbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXNCQTs7QUFDQTs7QUFDQTs7SUFBWUEsTTs7Ozs7O0lBRUNDLFMsV0FBQUEsUzs7O0FBQ1gscUJBQ0VDLFlBREYsRUFFRUMsWUFGRixFQUdFQyxVQUhGLEVBSUVDLGdCQUpGLEVBS0U7QUFBQTs7QUFBQSw0SUFDTUYsWUFETixFQUNvQixDQUFDO0FBQUEsYUFBTUcsR0FBR0MsS0FBSCxtQ0FBWUYsZ0JBQVosRUFBK0JILGFBQWFNLEdBQWIsQ0FBaUJKLFVBQWpCLENBQS9CLEVBQU47QUFBQSxLQUFELENBRHBCOztBQUdB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ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTcgUm9tYW4gTGFraHRhZHlyXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqL1xuXG5pbXBvcnQgeyBmaW5kIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFNpbmdsZVJvd1F1ZXJ5LCBNdWx0aXBsZVJvd3NRdWVyeSB9IGZyb20gJy4vcXVlcnknO1xuaW1wb3J0ICogYXMgdW5zYWZlIGZyb20gJy4vdXRpbC91bnNhZmUnO1xuXG5leHBvcnQgY2xhc3MgQmVsb25nc1RvIGV4dGVuZHMgU2luZ2xlUm93UXVlcnkge1xuICBjb25zdHJ1Y3RvcihcbiAgICBzb3VyY2VFbnRpdHksXG4gICAgcmVsYXRlZENsYXNzLFxuICAgIGZvcmVpZ25LZXksXG4gICAgZm9yZWlnbktleVRhcmdldCxcbiAgKSB7XG4gICAgc3VwZXIocmVsYXRlZENsYXNzLCBbcWIgPT4gcWIud2hlcmUoeyBbZm9yZWlnbktleVRhcmdldF06IHNvdXJjZUVudGl0eS5nZXQoZm9yZWlnbktleSkgfSldKTtcblxuICAgIHRoaXMuZm9yZWlnbktleSA9IGZvcmVpZ25LZXk7XG4gICAgdGhpcy5mb3JlaWduS2V5VGFyZ2V0ID0gZm9yZWlnbktleVRhcmdldDtcbiAgfVxuXG4gIHF1ZXJ5KGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIG5ldyBTaW5nbGVSb3dRdWVyeSh0aGlzLm1vZGVsQ2xhc3MsIFsuLi50aGlzLmZpbHRlcnMsIGNhbGxiYWNrXSwgdGhpcy5yZWxhdGlvbk5hbWVzKTtcbiAgfVxuXG4gIGluY2x1ZGluZyguLi5yZWxhdGlvbk5hbWVzKSB7XG4gICAgcmV0dXJuIG5ldyBTaW5nbGVSb3dRdWVyeShcbiAgICAgIHRoaXMubW9kZWxDbGFzcyxcbiAgICAgIHRoaXMuZmlsdGVycyxcbiAgICAgIFsuLi50aGlzLnJlbGF0aW9uTmFtZXMsIC4uLnJlbGF0aW9uTmFtZXNdLFxuICAgICk7XG4gIH1cblxuICBhc3luYyBleHRyYWN0UmVsYXRlZERhdGEocm93RGF0YSwgcmVsYXRpb25OYW1lLCBtb2RlbHMsIG5lc3RlZFJlbGF0aW9ucykge1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIGNvbnN0IGlkcyA9IHJvd0RhdGEubWFwKHJvdyA9PiByb3dbdGhhdC5mb3JlaWduS2V5XSk7XG5cbiAgICBsZXQgcXVlcnkgPSB0aGlzLm1vZGVsQ2xhc3NcbiAgICAgIC5vYmplY3RzKClcbiAgICAgIC5maWx0ZXIoeyBpZF9faW46IGlkcyB9KTtcblxuICAgIGlmIChuZXN0ZWRSZWxhdGlvbnMpIHtcbiAgICAgIHF1ZXJ5ID0gcXVlcnkuaW5jbHVkaW5nKG5lc3RlZFJlbGF0aW9ucyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVsYXRlZE1vZGVscyA9IGF3YWl0IHF1ZXJ5O1xuXG4gICAgbW9kZWxzLm1hcCgobW9kZWwpID0+IHtcbiAgICAgIGNvbnN0IHJlbGF0ZWRNb2RlbCA9IGZpbmQoXG4gICAgICAgIHJlbGF0ZWRNb2RlbHMsXG4gICAgICAgIG0gPT4gdW5zYWZlLmVxKG0uZ2V0KHRoYXQuZm9yZWlnbktleVRhcmdldCksIG1vZGVsLmlkKSxcbiAgICAgICk7XG4gICAgICByZXR1cm4gbW9kZWwuc2V0UmVsYXRlZERhdGEocmVsYXRpb25OYW1lLCByZWxhdGVkTW9kZWwpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJvd0RhdGE7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEhhc01hbnkgZXh0ZW5kcyBNdWx0aXBsZVJvd3NRdWVyeSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHNvdXJjZUVudGl0eSxcbiAgICByZWxhdGVkQ2xhc3MsXG4gICAgZm9yZWlnbktleSxcbiAgICBmb3JlaWduS2V5VGFyZ2V0LFxuICApIHtcbiAgICBzdXBlcihyZWxhdGVkQ2xhc3MsIFtxYiA9PiBxYi53aGVyZSh7IFtmb3JlaWduS2V5XTogc291cmNlRW50aXR5LmdldChmb3JlaWduS2V5VGFyZ2V0KSB9KV0pO1xuICAgIHRoaXMuZm9yZWlnbktleSA9IGZvcmVpZ25LZXk7XG4gIH1cblxuICBxdWVyeShjYWxsYmFjaykge1xuICAgIHJldHVybiBuZXcgTXVsdGlwbGVSb3dzUXVlcnkodGhpcy5tb2RlbENsYXNzLCBbLi4udGhpcy5maWx0ZXJzLCBjYWxsYmFja10sIHRoaXMucmVsYXRpb25OYW1lcyk7XG4gIH1cblxuICBpbmNsdWRpbmcoLi4ucmVsYXRpb25OYW1lcykge1xuICAgIHJldHVybiBuZXcgTXVsdGlwbGVSb3dzUXVlcnkoXG4gICAgICB0aGlzLm1vZGVsQ2xhc3MsXG4gICAgICB0aGlzLmZpbHRlcnMsXG4gICAgICBbLi4udGhpcy5yZWxhdGlvbk5hbWVzLCAuLi5yZWxhdGlvbk5hbWVzXSxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZXh0cmFjdFJlbGF0ZWREYXRhKHJvd3MsIHJlbGF0aW9uTmFtZSwgbW9kZWxzLCBuZXN0ZWRSZWxhdGlvbnMpIHtcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICBjb25zdCBpZHMgPSByb3dzLm1hcChyb3cgPT4gcm93LmlkKTtcblxuICAgIGxldCBxdWVyeSA9IHRoaXMubW9kZWxDbGFzc1xuICAgICAgLm9iamVjdHMoKVxuICAgICAgLmZpbHRlcih7IFtgJHt0aGlzLmZvcmVpZ25LZXl9X19pbmBdOiBpZHMgfSk7XG5cbiAgICBpZiAobmVzdGVkUmVsYXRpb25zKSB7XG4gICAgICBxdWVyeSA9IHF1ZXJ5LmluY2x1ZGluZyhuZXN0ZWRSZWxhdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlbGF0ZWRNb2RlbHMgPSBhd2FpdCBxdWVyeTtcblxuICAgIG1vZGVscy5tYXAoKG1vZGVsKSA9PiB7XG4gICAgICBjb25zdCBmaWx0ZXJlZE1vZGVscyA9IHJlbGF0ZWRNb2RlbHNcbiAgICAgICAgLmZpbHRlcihtID0+IHVuc2FmZS5lcShtLmdldCh0aGF0LmZvcmVpZ25LZXkpLCBtb2RlbC5pZCkpO1xuICAgICAgcmV0dXJuIG1vZGVsLnNldFJlbGF0ZWREYXRhKHJlbGF0aW9uTmFtZSwgZmlsdGVyZWRNb2RlbHMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJvd3M7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEJlbG9uZ3NUb01hbnkgZXh0ZW5kcyBNdWx0aXBsZVJvd3NRdWVyeSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHNvdXJjZUVudGl0eSxcbiAgICByZWxhdGVkQ2xhc3MsXG4gICAgcGl2b3RUYWJsZU5hbWUsXG4gICAgdGhpc0ZvcmVpZ25LZXksXG4gICAgdGhhdEZvcmVpZ25LZXksXG4gICAgdGhpc0ZvcmVpZ25LZXlUYXJnZXQsXG4gICAgdGhhdEZvcmVpZ25LZXlUYXJnZXQsXG4gICkge1xuICAgIHN1cGVyKHJlbGF0ZWRDbGFzcywgW3FiID0+IHFiXG4gICAgICAuaW5uZXJKb2luKFxuICAgICAgICBwaXZvdFRhYmxlTmFtZSxcbiAgICAgICAgYCR7cGl2b3RUYWJsZU5hbWV9LiR7dGhhdEZvcmVpZ25LZXl9YCxcbiAgICAgICAgYCR7cmVsYXRlZENsYXNzLnRhYmxlfS4ke3RoYXRGb3JlaWduS2V5VGFyZ2V0fWAsXG4gICAgICApXG4gICAgICAuc2VsZWN0KGAke3JlbGF0ZWRDbGFzcy50YWJsZX0uKmApXG4gICAgICAud2hlcmUoeyBbYCR7cGl2b3RUYWJsZU5hbWV9LiR7dGhpc0ZvcmVpZ25LZXl9YF06IHNvdXJjZUVudGl0eS5nZXQodGhpc0ZvcmVpZ25LZXlUYXJnZXQpIH0pLFxuICAgIF0pO1xuICAgIHRoaXMucGl2b3RUYWJsZU5hbWUgPSBwaXZvdFRhYmxlTmFtZTtcbiAgICB0aGlzLnRoaXNGb3JlaWduS2V5ID0gdGhpc0ZvcmVpZ25LZXk7XG4gICAgdGhpcy50aGF0Rm9yZWlnbktleSA9IHRoYXRGb3JlaWduS2V5O1xuICAgIHRoaXMudGhhdEZvcmVpZ25LZXlUYXJnZXQgPSB0aGF0Rm9yZWlnbktleVRhcmdldDtcbiAgfVxuXG4gIHF1ZXJ5KGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIG5ldyBNdWx0aXBsZVJvd3NRdWVyeSh0aGlzLm1vZGVsQ2xhc3MsIFsuLi50aGlzLmZpbHRlcnMsIGNhbGxiYWNrXSwgdGhpcy5yZWxhdGlvbk5hbWVzKTtcbiAgfVxuXG4gIGluY2x1ZGluZyguLi5yZWxhdGlvbk5hbWVzKSB7XG4gICAgcmV0dXJuIG5ldyBNdWx0aXBsZVJvd3NRdWVyeShcbiAgICAgIHRoaXMubW9kZWxDbGFzcyxcbiAgICAgIHRoaXMuZmlsdGVycyxcbiAgICAgIFsuLi50aGlzLnJlbGF0aW9uTmFtZXMsIC4uLnJlbGF0aW9uTmFtZXNdLFxuICAgICk7XG4gIH1cblxuICBhc3luYyBleHRyYWN0UmVsYXRlZERhdGEocm93cywgcmVsYXRpb25OYW1lLCBtb2RlbHMsIG5lc3RlZFJlbGF0aW9ucykge1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIGNvbnN0IGlkcyA9IHJvd3MubWFwKHJvdyA9PiByb3cuaWQpO1xuICAgIGNvbnN0IHRlbXBDb2x1bW5OYW1lID0gJ19fcmVsYXRlZF9pZCc7XG5cbiAgICBsZXQgcXVlcnkgPSB0aGlzLm1vZGVsQ2xhc3NcbiAgICAgIC5vYmplY3RzKClcbiAgICAgIC5xdWVyeShxYiA9PiAoXG4gICAgICAgIHFiXG4gICAgICAgICAgLmlubmVySm9pbihcbiAgICAgICAgICAgIHRoYXQucGl2b3RUYWJsZU5hbWUsXG4gICAgICAgICAgICBgJHt0aGF0LnBpdm90VGFibGVOYW1lfS4ke3RoYXQudGhhdEZvcmVpZ25LZXl9YCxcbiAgICAgICAgICAgIGAke3RoYXQubW9kZWxDbGFzcy50YWJsZX0uJHt0aGF0LnRoYXRGb3JlaWduS2V5VGFyZ2V0fWAsXG4gICAgICAgICAgKVxuICAgICAgICAgIC53aGVyZUluKGAke3RoYXQucGl2b3RUYWJsZU5hbWV9LiR7dGhhdC50aGlzRm9yZWlnbktleX1gLCBpZHMpXG4gICAgICAgICAgLnNlbGVjdChgJHt0aGF0LnBpdm90VGFibGVOYW1lfS4ke3RoYXQudGhpc0ZvcmVpZ25LZXl9IGFzICR7dGVtcENvbHVtbk5hbWV9YClcbiAgICAgICkpO1xuXG4gICAgaWYgKG5lc3RlZFJlbGF0aW9ucykge1xuICAgICAgcXVlcnkgPSBxdWVyeS5pbmNsdWRpbmcobmVzdGVkUmVsYXRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCByZWxhdGVkTW9kZWxzID0gYXdhaXQgcXVlcnk7XG5cbiAgICBtb2RlbHMubWFwKChtb2RlbCkgPT4ge1xuICAgICAgY29uc3QgZmlsdGVyZWRNb2RlbHMgPSByZWxhdGVkTW9kZWxzXG4gICAgICAgIC5maWx0ZXIobSA9PiB1bnNhZmUuZXEobS5nZXQodGVtcENvbHVtbk5hbWUpLCBtb2RlbC5pZCkpO1xuICAgICAgcmV0dXJuIG1vZGVsLnNldFJlbGF0ZWREYXRhKHJlbGF0aW9uTmFtZSwgZmlsdGVyZWRNb2RlbHMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJvd3M7XG4gIH1cbn1cbiJdfQ==